{"version":3,"file":"reactivity.cjs.js","sources":["../../shared/src/index.ts","../src/proxyHandlers.ts","../src/reactive.ts"],"sourcesContent":["/**\n *  判断是否是对象类型（数组，普通对象等）\n */\nexport const isObject = function (value: any) {\n  return typeof value === 'object' && value !== null\n}\n","import { isObject } from './../../shared/src/index'\n/**\n * 实现new Proxy(target, handlers)中的handlers\n * 如果是只读的（readonly），set应该报错\n * 是否深度的\n */\n\nimport { createReactiveProxy, reactive, readonly } from './reactive'\n\nfunction createGetter({\n  isReadonly,\n  isShallow\n}: {\n  isReadonly: boolean\n  isShallow: boolean\n}) {\n  return function get(\n    target: Record<string | number, any>,\n    key: string | number,\n    receiver: any\n  ) {\n    const value = Reflect.get(target, key, receiver)\n\n    if (!isReadonly) {\n      // 如果这个对象不是只读的，那么在经过代理的时候就要进行依赖收集\n      // 等会儿数据变化的时候，就需要对视图View进行更新了\n    }\n\n    if (isShallow) {\n      return value\n    }\n    if (isObject(value)) {\n      // vue3跟vue2不同，vue3是取值的时候才进行深度代理判断\n      // 而vue2是在reactive的时候就继续判断深度代理。二者不太相同，换句话说vue3可以说是懒代理\n      return isReadonly ? readonly(value) : reactive(value)\n    }\n\n    return value\n  }\n}\n\nfunction createSetter({\n  isReadonly,\n  isShallow\n}: {\n  isReadonly: boolean\n  isShallow: boolean\n}) {\n  return function set(\n    target: Record<string | number, any>,\n    key: string | number,\n    value: any,\n    receiver: any\n  ) {\n    if (isReadonly) return console.warn(`${JSON.stringify(target)} is readonly`)\n    Reflect.set(target, key, value, receiver)\n  }\n}\n\nconst mutableHandlers = {\n  get: createGetter({\n    isReadonly: false,\n    isShallow: false\n  }),\n  set: createSetter({\n    isReadonly: false,\n    isShallow: false\n  })\n}\n\nconst shallowReactiveHandlers = {\n  get: createGetter({\n    isReadonly: false,\n    isShallow: true\n  }),\n  set: createSetter({\n    isReadonly: false,\n    isShallow: true\n  })\n}\n\nconst readonlyHandlers = {\n  get: createGetter({\n    isReadonly: true,\n    isShallow: false\n  }),\n  set: createSetter({\n    isReadonly: true,\n    isShallow: false\n  })\n}\n\nconst shallowReadonlyHandlers = {\n  get: createGetter({\n    isReadonly: true,\n    isShallow: true\n  }),\n  set: createSetter({\n    isReadonly: true,\n    isShallow: true\n  })\n}\n\nexport {\n  mutableHandlers,\n  shallowReactiveHandlers,\n  readonlyHandlers,\n  shallowReadonlyHandlers\n}\n","import { isObject } from '@vue/shared'\nimport {\n  mutableHandlers,\n  readonlyHandlers,\n  shallowReactiveHandlers,\n  shallowReadonlyHandlers\n} from './proxyHandlers'\n\n/**\n * 是不是响应的，是不是只读的\n */\n// 使用WeakMap会自动垃圾回收，它不会造成内存泄漏，而且存储的key只能是对象\nconst reactiveMap = new WeakMap()\nconst readonlyMap = new WeakMap()\n\nexport function createReactiveProxy(\n  target: Record<string | number, any>,\n  {\n    isReadonly,\n    proxyHandlers\n  }: { isReadonly: boolean; proxyHandlers: Record<string, Function> }\n) {\n  // 如果不是对象类型，是普通类型或者函数类型，直接返回target\n  if (!isObject(target)) return target\n  // 不过在进行proxy生成之前，要判断下这个对象是不是已经被代理了，不需要重复代理\n\n  // 判断要创建的是不是一个只读的代理，那如果是，需要使用只读map去缓存，或者取缓存\n  const proxyMap = isReadonly ? readonlyMap : reactiveMap\n\n  // 如果代理map中有缓存过这个target对应的代理，直接返回缓存\n  if (proxyMap.has(target)) {\n    /**\n     * 做缓存判断，是为了防止用户出现以下的操作\n     * const o = {}\n     * const obj = createReactiveProxy(o)\n     * const obj1 = createReactiveProxy(o)\n     * 即多次代理，多次代理一个对象，我们就判断如果缓存中有了，就直接给它返回缓存即可\n     * 不需要代理多次\n     */\n    return proxyMap.get(target)\n  }\n\n  // 否则创建一个代理\n  const proxy = new Proxy(target, proxyHandlers)\n  // 并且将被代理对象与代理之间建立map联系\n  proxyMap.set(target, proxy)\n\n  return proxy\n}\n\nexport function reactive(target: any) {\n  return createReactiveProxy(target, {\n    isReadonly: false,\n    proxyHandlers: mutableHandlers\n  })\n}\n\nexport function shallowReactive(target: any) {\n  return createReactiveProxy(target, {\n    isReadonly: false,\n    proxyHandlers: shallowReactiveHandlers\n  })\n}\n\nexport function readonly(target: any) {\n  return createReactiveProxy(target, {\n    isReadonly: true,\n    proxyHandlers: readonlyHandlers\n  })\n}\n\nexport function shallowReadonly(target: any) {\n  return createReactiveProxy(target, {\n    isReadonly: true,\n    proxyHandlers: shallowReadonlyHandlers\n  })\n}\n"],"names":[],"mappings":"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"}